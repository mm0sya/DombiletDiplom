{% extends "base.html" %}
{% block title %}Корзина{% endblock %}

{% block head %}
    <script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
            return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                    row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                    headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
    </script>
    <script src="/static/js/utils.js"></script>
    <script>
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        const RESERVATION_DURATION = 15 * 60 * 1000;

        async function validateCart() {
            const invalidSeats = [];
            for (let i = cart.length - 1; i >= 0; i--) {
                const item = cart[i];
                const now = Date.now();
                if (now - item.reservationTime > RESERVATION_DURATION) {
                    invalidSeats.push(i);
                    continue;
                }
                const isAvailable = await checkSeatAvailability(item.match_id, item.sector_name, item.row, item.seat);
                if (!isAvailable) {
                    invalidSeats.push(i);
                }
            }
            invalidSeats.forEach(index => cart.splice(index, 1));
            updateCart(cart);
            renderCart();
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCart(cart);
            renderCart();
        }

        function clearCart() {
            cart = [];
            updateCart(cart);
            renderCart();
        }

        function renderCart() {
            const cartContainer = document.getElementById('cart-items');
            const totalPriceElement = document.getElementById('total-price');
            cartContainer.innerHTML = '';

            if (cart.length === 0) {
                cartContainer.innerHTML = '<p class="text-gray-500">Корзина пуста.</p>';
                totalPriceElement.textContent = '0 ₽';
                return;
            }

            // Получаем список матчей из шаблона
            const matches = {{ matches | tojson | safe }};

            let totalPrice = 0;
            cart.forEach((item, index) => {
                const remainingTime = Math.max(0, Math.floor((RESERVATION_DURATION - (Date.now() - item.reservationTime)) / 1000));
                const minutes = Math.floor(remainingTime / 60);
                const seconds = remainingTime % 60;
                const timeLeft = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

                // Находим матч по slug
                const match = matches.find(m => m.slug === item.match_id);
                let matchInfo = '';
                if (match) {
                    matchInfo = `<p class="font-semibold">Матч: <a href="/tickets/${match.slug}" class="text-blue-500 hover:underline">${match.teams}</a></p>`;
                } else {
                    matchInfo = `<p class="font-semibold">Матч: <span class="text-red-500">Не найден</span></p>`;
                }

                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            ${matchInfo}
                            <p>Сектор: ${item.sector_name}</p>
                            <p>Ряд: ${item.row}, Место: ${item.seat}</p>
                            <p>Цена: ${item.price} ₽</p>
                            <p>Осталось времени: <span id="time-${index}">${timeLeft}</span></p>
                        </div>
                        <button class="remove-button" onclick="removeFromCart(${index})">Удалить</button>
                    </div>
                `;
                cartContainer.appendChild(cartItem);
                totalPrice += item.price;
            });

            totalPriceElement.textContent = `${totalPrice} ₽`;
        }

        function showNotification(message) {
            alert(message);
        }

        async function submitCheckout() {
            const form = document.getElementById('checkout-form');
            const fullName = form.querySelector('#full_name').value;
            const email = form.querySelector('#email').value;
            const phone = form.querySelector('#phone').value;

            if (!fullName || !email || !phone) {
                alert('Пожалуйста, заполните все обязательные поля.');
                return;
            }

            const selectedSeats = JSON.stringify(cart);
            const formData = new FormData();
            formData.append('full_name', fullName);
            formData.append('email', email);
            formData.append('phone', phone);
            formData.append('selected_seats', selectedSeats);

            try {
                const response = await fetch('/checkout', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    cart = [];
                    updateCart(cart);
                    showNotification('Заказ успешно оформлен!');
                    window.location.href = '/cart?success=true';
                } else {
                    const errorText = await response.text();
                    showNotification(`Ошибка при оформлении заказа: ${errorText}`);
                }
            } catch (error) {
                console.error('Ошибка:', error);
                showNotification('Произошла ошибка при оформлении заказа.');
            }
        }

        window.onload = async function() {
            await validateCart();
            setInterval(() => {
                cart.forEach((item, index) => {
                    const remainingTime = Math.max(0, Math.floor((RESERVATION_DURATION - (Date.now() - item.reservationTime)) / 1000));
                    const minutes = Math.floor(remainingTime / 60);
                    const seconds = remainingTime % 60;
                    const timeLeft = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                    const timeElement = document.getElementById(`time-${index}`);
                    if (timeElement) {
                        timeElement.textContent = timeLeft;
                    }
                });
                validateCart();
            }, 1000);
        };
    </script>
    <link rel="stylesheet" href="/static/css/cart.css">
{% endblock %}

{% block content %}
    <main class="max-w-7xl mx-auto p-4">
        <div id="notification" class="notification"></div>
        <h2 class="text-2xl font-bold mb-4">Корзина</h2>
        <div id="cart-items"></div>
        <div class="mb-4">
            <h3 class="text-lg font-semibold mb-2">Контактные данные</h3>
            <form id="checkout-form" class="space-y-4">
                <div>
                    <label for="full_name" class="block text-sm font-medium text-gray-700">ФИО</label>
                    <input type="text" id="full_name" name="full_name" required class="mt-1 block w-full border rounded p-2">
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">E-mail</label>
                    <input type="email" id="email" name="email" required class="mt-1 block w-full border rounded p-2">
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700">Номер телефона</label>
                    <input type="tel" id="phone" name="phone" required class="mt-1 block w-full border rounded p-2">
                </div>
            </form>
        </div>
        <div class="flex justify-between items-center mb-4">
            <p class="text-lg font-semibold">Итого: <span id="total-price">0 ₽</span></p>
            <div class="flex gap-4">
                <button class="clear-button" onclick="clearCart()">Очистить корзину</button>
                <button class="cta-button" onclick="submitCheckout()">Оформить заказ</button>
            </div>
        </div>
    </main>
{% endblock %}