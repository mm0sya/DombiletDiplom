{% extends "base.html" %}
{% block title %}Редактирование матча{% endblock %}
{% block head %}
    <script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
            return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];
    
                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));
    
                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                    row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                    headerRowIndex = 0;
                }
    
                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
    </script>
    <script>
        var pendingSeatChanges = {};
        var totalSeats = 0;

        function toggleSection(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                if (element.classList.contains('active')) {
                    element.classList.remove('active');
                } else {
                    element.classList.add('active');
                }
                saveToggleState();
            } else {
                console.error('Element not found for ID:', elementId);
            }
        }

        async function updateSectorPrice(matchSlug, sectorName, formId) {
            const form = document.getElementById(formId);
            const priceInput = form.querySelector('input[name="price"]');
            const newPrice = priceInput.value;

            if (!newPrice || isNaN(newPrice) || newPrice <= 0) {
                alert("Пожалуйста, введите корректную цену (положительное число).");
                return;
            }

            try {
                const response = await fetch(`/admin-panel/edit_sector/${matchSlug}/${sectorName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `price=${newPrice}`
                });

                if (response.ok) {
                    alert("Цена сектора успешно обновлена!");
                } else {
                    const errorText = await response.text();
                    alert(`Ошибка при обновлении цены: ${errorText}`);
                }
            } catch (error) {
                console.error('Ошибка:', error);
                alert("Произошла ошибка при обновлении цены.");
            }
        }

        function updateAvailableSeats(sectorId) {
            const seats = document.querySelectorAll(`#sector-${sectorId} .seat-status`);
            let availableCount = 0;
            seats.forEach(seat => {
                const seatNumber = seat.closest('li')?.querySelector('.seat-item')?.getAttribute('data-number') ||
                                seat.closest('.seat-item')?.getAttribute('data-number');
                const isPendingOccupied = pendingSeatChanges[sectorId]?.[seatNumber] === 'occupied';
                const isPendingAvailable = pendingSeatChanges[sectorId]?.[seatNumber] === 'available';
                
                if (isPendingAvailable || (!isPendingOccupied && seat.textContent === 'Свободно')) {
                    availableCount++;
                }
            });
            const headerElement = document.getElementById(`sector-header-${sectorId}`);
            headerElement.textContent = `Сектор ${sectorId}. Свободно: ${availableCount} шт.`;

            updateTotalSeats();
        }

        function updateTotalSeats() {
            let totalAvailable = 0;
            document.querySelectorAll('.sector-seats').forEach(sector => {
                const sectorId = JSON.parse(sector.getAttribute('data-sector')).sectorName;
                const seats = document.querySelectorAll(`#sector-${sectorId} .seat-status`);
                seats.forEach(seat => {
                    const seatNumber = seat.closest('li')?.querySelector('.seat-item')?.getAttribute('data-number') ||
                                    seat.closest('.seat-item')?.getAttribute('data-number');
                    const isPendingOccupied = pendingSeatChanges[sectorId]?.[seatNumber] === 'occupied';
                    const isPendingAvailable = pendingSeatChanges[sectorId]?.[seatNumber] === 'available';
                    
                    if (isPendingAvailable || (!isPendingOccupied && seat.textContent === 'Свободно')) {
                        totalAvailable++;
                    }
                });
            });
            totalSeats = totalAvailable;
            const totalSeatsInput = document.getElementById('total_seats');
            if (totalSeatsInput) {
                totalSeatsInput.value = totalSeats;
            }
        }

        function toggleSeatStatus(matchSlug, sectorName, seatNumber, action, buttonElement) {
            const statusSpan = buttonElement.closest('li').querySelector('.seat-status');
            const liElement = buttonElement.closest('li');
            const currentStatus = statusSpan.textContent === 'Свободно' ? 'available' : 'occupied';

            if (!pendingSeatChanges[sectorName]) {
                pendingSeatChanges[sectorName] = {};
            }

            if (!pendingSeatChanges[sectorName][seatNumber]?.originalStatus) {
                pendingSeatChanges[sectorName][seatNumber] = {
                    originalStatus: currentStatus,
                    status: currentStatus
                };
            }

            const newStatus = action === 'deactivate' ? 'occupied' : 'available';
            pendingSeatChanges[sectorName][seatNumber].status = newStatus;

            if (pendingSeatChanges[sectorName][seatNumber].status === pendingSeatChanges[sectorName][seatNumber].originalStatus) {
                delete pendingSeatChanges[sectorName][seatNumber];
                liElement.classList.remove('pending-change');
                if (Object.keys(pendingSeatChanges[sectorName]).length === 0) {
                    delete pendingSeatChanges[sectorName];
                }
            } else {
                liElement.classList.add('pending-change');
            }

            if (action === 'deactivate') {
                statusSpan.textContent = 'Занято';
                buttonElement.textContent = 'Активировать';
                buttonElement.classList.remove('text-red-500');
                buttonElement.classList.add('text-green-500');
                buttonElement.onclick = () => toggleSeatStatus(matchSlug, sectorName, seatNumber, 'activate', buttonElement);
            } else {
                statusSpan.textContent = 'Свободно';
                buttonElement.textContent = 'Деактивировать';
                buttonElement.classList.remove('text-green-500');
                buttonElement.classList.add('text-red-500');
                buttonElement.onclick = () => toggleSeatStatus(matchSlug, sectorName, seatNumber, 'deactivate', buttonElement);
            }

            updateAvailableSeats(sectorName);
        }

        function saveToggleState() {
            const openSections = [];
            document.querySelectorAll('.toggle-content').forEach((section) => {
                if (section.classList.contains('active')) {
                    openSections.push(section.id);
                }
            });
            localStorage.setItem('openSections', JSON.stringify(openSections));
        }

        function restoreToggleState() {
            const openSections = JSON.parse(localStorage.getItem('openSections') || '[]');
            openSections.forEach((sectionId) => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.add('active');
                }
            });
        }

        function groupSeatsByRows() {
            const seatsPerRow = 35;
            document.querySelectorAll('.sector-seats').forEach(sector => {
                const sectorData = JSON.parse(sector.getAttribute('data-sector'));
                const sectorId = sectorData.sectorName;
                const matchSlug = sectorData.matchId;
                const sectorPrice = parseInt(sector.getAttribute('data-price'));
                const seats = Array.from(sector.querySelectorAll('.seat-item')).map(seat => ({
                    number: parseInt(seat.getAttribute('data-number')),
                    available: seat.getAttribute('data-available') === 'true' || seat.getAttribute('data-available') === 'True',
                    deleteUrl: seat.getAttribute('data-delete-url'),
                    price: seat.getAttribute('data-price') ? Number(seat.getAttribute('data-price')) : 0,
                    originalPrice: seat.getAttribute('data-price') ? Number(seat.getAttribute('data-price')) : 0
                }));

                const rows = {};
                seats.forEach(seat => {
                    const rowNumber = Math.floor((seat.number - 1) / seatsPerRow) + 1;
                    if (!rows[rowNumber]) {
                        rows[rowNumber] = [];
                    }
                    rows[rowNumber].push(seat);
                });

                const rowsContainer = document.createElement('div');
                for (const rowNumber in rows) {
                    const localSeats = rows[rowNumber].map(seat => ({
                        ...seat,
                        localNumber: (seat.number - 1) % seatsPerRow + 1
                    }));
                    const rowId = `row-${sectorId}-${rowNumber}`;
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'ml-4 mt-2 row-container';
                    rowDiv.innerHTML = `
                        <p class="cursor-pointer" onclick="toggleSection('${rowId}')">
                            Ряд ${rowNumber}
                        </p>
                        <div id="${rowId}" class="toggle-content">
                            <ul class="ml-4 mt-2">
                                ${localSeats.map(seat => `
                                    <li class="flex justify-between items-center py-1">
                                        <span>Место ${seat.localNumber}: <span class="seat-status">${seat.available ? 'Свободно' : 'Занято'}</span> <span class="seat-price">${typeof seat.price !== 'undefined' && seat.price !== null ? seat.price : 0} ₽</span></span>
                                        <div class="flex items-center space-x-2">
                                            <button onclick="startEditSeatPrice(this, '${sectorId}', ${seat.number}, ${seat.originalPrice})" class="text-blue-500 hover:underline mx-1">Изменить цену</button>
                                            <button onclick="toggleSeatStatus('${matchSlug}', '${sectorId}', ${seat.number}, '${seat.available ? 'deactivate' : 'activate'}', this)" class="${seat.available ? 'text-red-500' : 'text-green-500'} hover:underline">${seat.available ? 'Деактивировать' : 'Активировать'}</button>
                                            <a href="/admin-panel/deactivate_seat/${matchSlug}/${sectorId}/${seat.number}" class="text-red-500 hover:underline">Удалить</a>
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                    rowsContainer.appendChild(rowDiv);
                }

                sector.replaceWith(rowsContainer);
            });
            restoreToggleState();
            updateTotalSeats();
        }

        function startEditSeatPrice(button, sectorId, seatNumber, currentPrice) {
            const li = button.closest('li');
            const priceSpan = li.querySelector('.seat-price');
            button.style.display = 'none';
            const input = document.createElement('input');
            input.type = 'number';
            input.value = currentPrice;
            input.min = 1;
            input.className = 'border rounded p-1 w-20 mx-2';
            input.style.width = '70px';
            const okBtn = document.createElement('button');
            okBtn.textContent = 'Ок';
            okBtn.className = 'text-green-500 hover:underline mx-1';
            okBtn.onclick = function() {
                const newPrice = Number(input.value.trim());
                if (!newPrice || isNaN(newPrice) || newPrice <= 0) {
                    alert('Пожалуйста, введите корректную цену (положительное число).');
                    return;
                }
                if (!pendingSeatChanges[sectorId]) pendingSeatChanges[sectorId] = {};
                if (!pendingSeatChanges[sectorId][seatNumber]) pendingSeatChanges[sectorId][seatNumber] = {};
                const statusSpan = li.querySelector('.seat-status');
                const currentStatus = statusSpan.textContent === 'Свободно' ? 'available' : 'occupied';
                pendingSeatChanges[sectorId][seatNumber].price = newPrice;
                pendingSeatChanges[sectorId][seatNumber].status = currentStatus;
                li.classList.add('pending-change');
                priceSpan.textContent = newPrice + ' ₽';
                input.remove();
                okBtn.remove();
                button.style.display = '';
            };
            priceSpan.parentNode.appendChild(input);
            priceSpan.parentNode.appendChild(okBtn);
            input.focus();
        }

        window.onload = function() {
            groupSeatsByRows();

            document.getElementById('edit-match-form').addEventListener('submit', async function(event) {
                event.preventDefault();

                const formData = new FormData(this);
                try {
                    const formResponse = await fetch(this.action, {
                        method: 'POST',
                        body: formData
                    });

                    if (!formResponse.ok) {
                        const errorText = await formResponse.text();
                        alert(`Ошибка при сохранении матча: ${errorText}`);
                        return;
                    }

                    if (Object.keys(pendingSeatChanges).length > 0) {
                        const matchSlug = '{{ match.slug }}';
                        const payload = {
                            seat_changes: pendingSeatChanges,
                            total_seats: totalSeats
                        };
                        const response = await fetch(`/admin-panel/update_seats/${matchSlug}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            alert('Изменения успешно сохранены!');
                            pendingSeatChanges = {};
                            document.querySelectorAll('.pending-change').forEach(el => el.classList.remove('pending-change'));
                            document.querySelectorAll('.sector-seats').forEach(sector => {
                                updateAvailableSeats(JSON.parse(sector.getAttribute('data-sector')).sectorName);
                            });
                        } else {
                            const errorText = await response.text();
                            alert(`Ошибка при сохранении статусов мест: ${errorText}`);
                        }
                    } else {
                        alert('Матч успешно сохранен!');
                    }
                } catch (error) {
                    console.error('Ошибка:', error);
                    alert('Произошла ошибка при сохранении.');
                }
            });
        };
    </script>
    <link rel="stylesheet" href="/static/css/edit_match.css">
{% endblock %}

{% block user_menu %}
    <a href="/admin-panel" class="hover:underline">{{ username }}</a>
    <a href="/admin-panel/logout" class="hover:underline">Выход</a>
{% endblock %}

{% block content %}
    <main class="max-w-7xl mx-auto p-4">
        <div class="section-box">
            <h2 class="section-title">Основная информация</h2>
            <form id="edit-match-form" method="POST" action="/admin-panel/edit_match/{{ match.slug }}" enctype="multipart/form-data" class="mb-6">
                <div class="mb-4">
                    <div class="flex items-center mb-4">
                        <label for="is_active" class="mr-2 font-medium">Активен</label>
                        <input type="checkbox" name="is_active" value="true" {% if match.is_active %}checked{% endif %}>
                    </div>
                    <input type="text" id="teams" name="teams" value="{{ match.teams }}" required class="mt-1 block w-full border rounded p-2">
                    <div class="flex items-center mt-2">
                        <label for="slug" class="mr-2 font-medium">URL (транслит)</label>
                        <input type="text" id="slug" name="slug" value="{{ match.slug }}" class="block w-full border rounded p-2" style="max-width: 400px;">
                    </div>
                </div>
                <div class="mb-4">
                    <label for="date" class="block text-sm font-medium text-gray-700">Дата</label>
                    <input type="date" id="date" name="date" value="{{ match.date }}" required class="mt-1 block w-full border rounded p-2">
                </div>
                <div class="mb-4">
                    <label for="time" class="block text-sm font-medium text-gray-700">Время</label>
                    <input type="time" id="time" name="time" value="{{ match.time }}" required class="mt-1 block w-full border rounded p-2">
                </div>
                <div class="mb-4">
                    <label for="tournament" class="block text-sm font-medium text-gray-700">Турнир</label>
                    <select id="tournament" name="tournament" class="mt-1 block w-full border rounded p-2">
                        <option value="Кубок России" {{ 'selected' if match.tournament == 'Кубок России' else '' }}>Кубок России</option>
                        <option value="РПЛ" {{ 'selected' if match.tournament == 'РПЛ' else '' }}>РПЛ</option>
                        <option value="Товарищеские матчи" {{ 'selected' if match.tournament == 'Товарищеские матчи' else '' }}>Товарищеские матчи</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="image" class="block text-sm font-medium text-gray-700">Изображение</label>
                    <input type="file" id="image" name="image" class="mt-1 block w-full">
                </div>
                <input type="hidden" id="total_seats" name="total_seats" value="0">
            </form>
        </div>

        <div class="section-box">
            <h2 class="section-title">Управление секторами</h2>
            {% if match.sectors %}
                {% for sector in match.sectors %}
                    {% set available_count = sector.seats | selectattr('available', 'equalto', true) | list | length %}
                    <div class="border rounded p-4 mb-4">
                        <div class="sector-header">
                            <h4 class="text-lg font-medium cursor-pointer" onclick="toggleSection('sector-{{ sector.name }}')">
                                <span id="sector-header-{{ sector.name }}">Сектор {{ sector.name }}. Свободно: {{ available_count }} шт.</span>
                            </h4>
                            <div class="flex items-center space-x-2">
                                <div class="w-full max-w-md flex items-center">
                                    <form method="POST" action="/admin-panel/delete_sector/{{ match.slug }}/{{ sector.name }}" class="ml-4">
                                        <button type="submit" class="text-red-500 hover:underline whitespace-nowrap">Удалить</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div id="sector-{{ sector.name }}" class="toggle-content">
                            <div class="sector-seats" data-sector='{"matchId": "{{ match.slug }}", "sectorName": "{{ sector.name }}"}' data-price="{{ sector.price }}">
                                {% if sector.seats %}
                                    {% for seat in sector.seats %}
                                        <div class="seat-item" data-number="{{ seat.number }}" data-available="{{ 'true' if seat.available else 'false' }}" data-delete-url="/admin-panel/deactivate_seat/{{ match.slug }}/{{ sector.name }}/{{ seat.number }}" data-price="{{ seat.price }}"></div>
                                    {% endfor %}
                                {% else %}
                                    <p>Нет мест в этом секторе.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p>Сектора отсутствуют.</p>
            {% endif %}
            <div class="mt-4">
                <a href="/admin-panel/bulk_add_sectors/{{ match.slug }}" class="cta-button">Добавить сектора</a>
            </div>
        </div>

        <div class="mt-6">
            <button form="edit-match-form" type="submit" class="cta-button">Сохранить</button>
            <a href="/admin-panel" class="back-button ml-2">Назад</a>
        </div>
    </main>
{% endblock %}