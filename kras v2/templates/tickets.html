{% extends "base.html" %}
{% block title %}{{ match.teams }}{% endblock %}

{% block head %}
    <style>
        .hero-section {
            background-image: url('/static/backgrounds/{{ match.image }}');
            height: 1000px;
            width: 100%;
        }
    </style>
    <script src="/static/js/utils.js"></script>
    <script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
    </script>
    <script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
        return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                var filteredData = jsonData.filter(row => row.some(filledCell));
                var headerRowIndex = filteredData.findIndex((row, index) =>
                row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                headerRowIndex = 0;
                }
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
    </script>
    <script>
        function selectSector(sectorName) {
            const matchId = "{{ match.slug }}";
            window.location.href = `/sector_view/${matchId}/${sectorName}`;
        }
    
        function scrollToStadiumMap() {
            const stadiumMap = document.querySelector('.stadium-map');
            const offset = 100; // –ó–∞–¥–∞–π—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–º–µ—â–µ–Ω–∏—è
            const elementPosition = stadiumMap.getBoundingClientRect().top + window.scrollY;
            const offsetPosition = elementPosition - offset;

            window.scrollTo({
                top: offsetPosition,
                behavior: 'smooth'
            });
        }
    
        function formatDate(dateString, timeString) {
            const months = [
                '–Ø–Ω–≤–∞—Ä—è', '–§–µ–≤—Ä–∞–ª—è', '–ú–∞—Ä—Ç–∞', '–ê–ø—Ä–µ–ª—è', '–ú–∞—è', '–ò—é–Ω—è',
                '–ò—é–ª—è', '–ê–≤–≥—É—Å—Ç–∞', '–°–µ–Ω—Ç—è–±—Ä—è', '–û–∫—Ç—è–±—Ä—è', '–ù–æ—è–±—Ä—è', '–î–µ–∫–∞–±—Ä—è'
            ];
            const date = new Date(dateString + 'T' + (timeString || '00:00'));
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${day} ${month} ${year}, ${hours}:${minutes}`;
        }
    
        function toggleTickets() {
            const ticketsSection = document.querySelector('.tickets-section');
            ticketsSection.classList.toggle('active');
        }
    
        window.onload = function() {
            updateCartCount();
            const dateElement = document.querySelector('.match-info .date');
            const rawDate = dateElement.getAttribute('data-date');
            const rawTime = dateElement.getAttribute('data-time');
            dateElement.textContent = formatDate(rawDate, rawTime);
        };
    
        document.addEventListener('DOMContentLoaded', function () {
            const tooltip = document.getElementById('sector-tooltip');
            const sectors = document.querySelectorAll('.sector.active');
            const filterButtons = document.querySelectorAll('.price-filter');
            let activeFilter = null;
    
            sectors.forEach(sector => {
                const sectorName = sector.getAttribute('data-id');
    
                sector.addEventListener('mouseover', function (e) {
                    const availableSeats = getAvailableSeats(sectorName);
                    const priceRange = getSectorPriceRange(sectorName);
    
                    tooltip.querySelector('.sector-name').textContent = `–°–µ–∫—Ç–æ—Ä ${sectorName}`;
                    tooltip.querySelector('#available-seats').textContent = availableSeats;
                    if (priceRange.min === priceRange.max) {
                        tooltip.querySelector('#sector-price').textContent = priceRange.min;
                    } else {
                        tooltip.querySelector('#sector-price').textContent = priceRange.min + '‚Äì' + priceRange.max;
                    }
    
                    tooltip.style.display = 'block';
                    tooltip.style.left = e.pageX + 10 + 'px';
                    tooltip.style.top = e.pageY + 10 + 'px';
                });
    
                sector.addEventListener('mousemove', function (e) {
                    const tooltipWidth = tooltip.offsetWidth;
                    const tooltipHeight = tooltip.offsetHeight;
                    const windowWidth = window.innerWidth;
                    const windowHeight = window.innerHeight;
    
                    let left = e.pageX + 10;
                    let top = e.pageY + 10;
    
                    if (left + tooltipWidth > windowWidth) {
                        left = e.pageX - tooltipWidth - 10;
                    }
    
                    if (top + tooltipHeight > windowHeight) {
                        top = e.pageY - tooltipHeight - 10;
                    }
    
                    if (left < 0) {
                        left = 10;
                    }
    
                    if (top < 0) {
                        top = 10;
                    }
    
                    tooltip.style.left = left + 'px';
                    tooltip.style.top = top + 'px';
                });
    
                sector.addEventListener('mouseout', function () {
                    tooltip.style.display = 'none';
                });
            });
    
            function getAvailableSeats(sectorName) {
                const sector = {{ match.sectors | tojson | safe }}.find(s => s.name === sectorName);
                if (sector && sector.seats) {
                    return sector.seats.filter(seat => seat.available).length;
                }
                return 0;
            }
    
            function getSectorPriceRange(sectorName) {
                const sector = {{ match.sectors | tojson | safe }}.find(s => s.name === sectorName);
                if (sector && sector.seats) {
                    const prices = sector.seats.filter(seat => seat.available).map(seat => seat.price);
                    if (prices.length > 0) {
                        return {min: Math.min(...prices), max: Math.max(...prices)};
                    }
                }
                return {min: 0, max: 0};
            }
    
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –∏ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–æ–≤
            function applySectorHighlight(minPrice, maxPrice, isPreview = false) {
                sectors.forEach(sector => {
                    const sectorName = sector.getAttribute('data-id');
                    const price = getSectorPriceRange(sectorName);
    
                    if (price.min >= minPrice && price.max <= maxPrice) {
                        sector.classList.remove('dimmed');
                        sector.classList.add('highlighted');
                    } else if (isPreview) {
                        sector.classList.add('dimmed');
                        sector.classList.remove('highlighted');
                    }
                });
            }
    
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–æ–≤
            function restoreSectorState() {
                sectors.forEach(sector => {
                    const sectorName = sector.getAttribute('data-id');
                    const price = getSectorPriceRange(sectorName);
    
                    if (activeFilter) {
                        const minPrice = parseInt(activeFilter.getAttribute('data-min'));
                        const maxPrice = parseInt(activeFilter.getAttribute('data-max'));
                        if (price.min >= minPrice && price.max <= maxPrice) {
                            sector.classList.remove('dimmed');
                            sector.classList.add('highlighted');
                        } else {
                            sector.classList.add('dimmed');
                            sector.classList.remove('highlighted');
                        }
                    } else {
                        sector.classList.remove('dimmed', 'highlighted');
                    }
                });
    
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
                filterButtons.forEach(btn => {
                    if (activeFilter && btn !== activeFilter) {
                        btn.classList.add('dimmed');
                    } else {
                        btn.classList.remove('dimmed');
                    }
                });
            }
    
            // –ö–æ–¥ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            filterButtons.forEach(button => {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞
                button.addEventListener('click', function () {
                    const minPrice = parseInt(button.getAttribute('data-min'));
                    const maxPrice = parseInt(button.getAttribute('data-max'));
    
                    // –ï—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –µ–≥–æ
                    if (activeFilter === button) {
                        sectors.forEach(sector => {
                            sector.classList.remove('dimmed', 'highlighted');
                        });
                        filterButtons.forEach(btn => {
                            btn.classList.remove('dimmed');
                        });
                        activeFilter.classList.remove('active');
                        activeFilter = null;
                        return;
                    }
    
                    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä
                    if (activeFilter) {
                        activeFilter.classList.remove('active');
                    }
    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä
                    button.classList.add('active');
                    activeFilter = button;
    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–µ–∫—Ç–æ—Ä–æ–≤
                    applySectorHighlight(minPrice, maxPrice);
    
                    // –ó–∞—Ç–µ–º–Ω—è–µ–º –∫–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤, –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–º—É —Ñ–∏–ª—å—Ç—Ä—É
                    filterButtons.forEach(btn => {
                        if (btn !== activeFilter) {
                            btn.classList.add('dimmed');
                        } else {
                            btn.classList.remove('dimmed');
                        }
                    });
                });
    
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–≤–µ–¥–µ–Ω–∏—è –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                button.addEventListener('mouseover', function () {
                    const minPrice = parseInt(button.getAttribute('data-min'));
                    const maxPrice = parseInt(button.getAttribute('data-max'));
    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                    applySectorHighlight(minPrice, maxPrice, true);
    
                    // –ó–∞—Ç–µ–º–Ω—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
                    filterButtons.forEach(btn => {
                        if (btn !== button) {
                            btn.classList.add('dimmed');
                        } else {
                            btn.classList.remove('dimmed');
                        }
                    });
                });
    
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ–¥–µ–Ω–∏—è –∫—É—Ä—Å–æ—Ä–∞
                button.addEventListener('mouseout', function () {
    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ–∫—Ç–æ—Ä–æ–≤ –∏ –∫–Ω–æ–ø–æ–∫
                    restoreSectorState();
                });
            });
        });
    </script>
    <link rel="stylesheet" href="/static/css/tickets.css">
{% endblock %}

{% block content %}
    <section class="hero-section">
    </section>
    <main style="max-width: 1400px; margin-left: auto; margin-right: auto;">
        {% set all_prices = [] %}
        {% for sector in match.sectors %}
            {% for seat in sector.seats %}
                {% if seat.available %}
                    {% set _ = all_prices.append(seat.price) %}
                {% endif %}
            {% endfor %}
        {% endfor %}

        <div class="match-info">
            <div style="position: relative; width: 100%;">
                <div class="header-info">
                    <div class="match-type">‚öΩ –§—É—Ç–±–æ–ª—å–Ω—ã–π –º–∞—Ç—á</div>
                    <div class="location">üìç –≥. –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä, –ø–ª–æ—â–∞–¥–∫–∞: OZON –∞—Ä–µ–Ω–∞</div>
                    <div class="price-section">
                        <div class="price">–°—Ç–æ–∏–º–æ—Å—Ç—å: <span>–û—Ç {{ all_prices|min }} ‚ÇΩ</span></div>
                    </div>
                </div>
                <h2>–ë–∏–ª–µ—Ç—ã –Ω–∞ <span>{{ match.teams }}</span></h2>
                <p class="date" data-date="{{ match.date }}" data-time="{{ match.time|default('00:00') }}"></p>
                <div class="buy-section">
                    <a class="scroll-button" onclick="scrollToStadiumMap()">–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ–∫—É–ø–∫–µ</a>
                </div>
            </div>
        </div>

        <div class="info-section">
            <div class="info-wrapper">
                <div class="info-container">
                    <div class="info-block">
                        <h3><span class="number">1</span> –ö–∞–∫ –≤—ã–±—Ä–∞—Ç—å –º–µ—Å—Ç–∞?</h3>
                        <p>–°–≤–æ–±–æ–¥–Ω—ã–µ –º–µ—Å—Ç–∞ –ø–æ–¥—Å–≤–µ—á–∏–≤—ã —Ü–≤–µ—Ç–æ–º. –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–∫—Ç–æ—Ä, –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–µ –≤–∞—Å –º–µ—Å—Ç–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ –∏–∫–æ–Ω–∫—É –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –¥–ª—è –≤–≤–æ–¥–∞ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.</p>
                    </div>
                    <div class="info-block">
                        <h3><span class="number">2</span> –ö–∞–∫ –æ–ø–ª–∞—Ç–∏—Ç—å –±–∏–ª–µ—Ç—ã?</h3>
                        <p>–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω—ã–π –¥–ª—è –≤–∞—Å —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã: –±–∞–Ω–∫–æ–≤—Å–∫–æ–π –∫–∞—Ä—Ç–æ–π –∏–ª–∏ –Ω–∞–ª–∏—á–Ω—ã–º–∏ –∫—É—Ä—å–µ—Ä—É –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –±–∏–ª–µ—Ç–æ–≤.</p>
                    </div>
                    <div class="info-block">
                        <h3><span class="number">3</span> –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –±–∏–ª–µ—Ç—ã?</h3>
                        <p>–° –ø–æ–º–æ—â—å—é –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ –∏–ª–∏ —Å–∞–º–æ–≤—ã–≤–æ–∑–∞. –î–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–º–∏ –±–∏–ª–µ—Ç–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–¥—É—Ç –≤–∞–º –Ω–∞ –ø–æ—á—Ç—É.</p>
                    </div>
                </div>
            </div>
        </div>

        {% include 'stadium_map.html' %} <!--  –ø–æ–¥–≥—Ä—É–∑–∫–∞ svg —Å—Ç–∞–¥–∏–æ–Ω–∞   -->

        <div id="sector-tooltip" class="tooltip">
            <p class="sector-name">–°–µ–∫—Ç–æ—Ä</p>
            <p>–°–≤–æ–±–æ–¥–Ω—ã—Ö –º–µ—Å—Ç: <span id="available-seats">0</span></p>
            <p class="price">–¶–µ–Ω–∞: <span id="sector-price">0</span> ‚ÇΩ</p>
        </div>

            <div class="contact-section">
                <div class="contact-text">
                    –ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã, –∑–≤–æ–Ω–∏—Ç–µ –ø–æ –Ω–æ–º–µ—Ä—É <a href="tel:7(900)777-77-77"> +7(900) 777-77-77</a>
                </div>
            </div>
        </div>
    </main>
{% endblock %}