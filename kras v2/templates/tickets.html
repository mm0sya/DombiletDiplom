<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><script type="text/javascript">
    var gk_isXlsx = false;
    var gk_xlsxFileLookup = {};
    var gk_fileData = {};
    function filledCell(cell) {
      return cell !== '' && cell != null;
    }
    function loadFileData(filename) {
    if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
        try {
            var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
            var firstSheetName = workbook.SheetNames[0];
            var worksheet = workbook.Sheets[firstSheetName];
            var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
            var filteredData = jsonData.filter(row => row.some(filledCell));
            var headerRowIndex = filteredData.findIndex((row, index) =>
              row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
            );
            if (headerRowIndex === -1 || headerRowIndex > 25) {
              headerRowIndex = 0;
            }
            var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
            csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
            return csv;
        } catch (e) {
            console.error(e);
            return "";
        }
    }
    return gk_fileData[filename] || "";
    }
</script>
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Покупка билетов</title>
<link rel="icon" href="/static/image/favicon.ico" type="image/x-icon">
<script src="https://cdn.tailwindcss.com"></script>
<style>
body {
    font-family: 'Inter', sans-serif;
    margin: 0;
    padding: 0;
}
.dark-green {
    background-color: #1A3C34;
}
.dark-green:hover {
    background-color: #2A5C4A;
}
.light-gray {
    background-color: #F5F7FA;
}
.match-banner {
    width: 100%;
    height: 850px;
    background-size: cover;
    background-position: center;
    position: relative;
}
.match-info {
    background-color: white;
    border-radius: 18px;
    padding: 40px;
    margin: 0 auto;
    max-width: 1400px;
    position: relative;
    top: -100px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}
.match-info .header-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    margin-bottom: 16px;
}
.match-info .header-info .match-type {
    font-size: 14px;
    color: #6B7280;
}
.match-info .header-info .location {
    font-size: 14px;
    color: #6B7280;
}
.match-info .header-info .price-section {
    display: flex;
    align-items: center;
}
.match-info .header-info .price-section .price {
    font-size: 14px;
    color: #6B7280;
}
.match-info .header-info .price-section .price span {
    font-weight: bold;
}
.match-info h2 {
    font-size: 32px;
    font-weight: bold;
    color: #1F2A44;
    margin: 0;
}
.match-info h2 span {
    font-size: 32px;
    font-weight: bold;
    color: #1F2A44;
}
.match-info p.date {
    font-size: 16px;
    color: #6B7280;
    margin: 8px 0 4px 0;
}
.match-info .buy-section {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 8px;
}
.match-info .buy-button {
    background-color: #34C759;
    color: white;
    padding: 14px 28px;
    border-radius: 8px;
    font-weight: bold;
    text-align: center;
    transition: background-color 0.2s;
    cursor: pointer;
    position: absolute;
    bottom: 40px;
    right: 40px;
}
.match-info .buy-button:hover {
    background-color: #2EB648;
}
.stadium-map {
    width: 100%;
    max-width: 1400px; /* Ограничиваем максимальную ширину */
    height: 800px;
    background-color: white;
    border-radius: 18px;
    margin: 0 auto; /* Отцентрировать блок */
    display: flex;
    justify-content: center;
    align-items: center;
}
.stadium-map svg {
    max-width: 100%;
    max-height: 100%;
}
.ticket-section {
    border-bottom: 1px solid #e5e7eb;
    padding: 10px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.ticket-section:last-child {
    border-bottom: none;
}
.select-button {
    background-color: #34C759;
    color: white;
    padding: 8px 16px;
    border-radius: 4px;
    transition: background-color 0.2s;
}
.select-button:hover {
    background-color: #2EB648;
}
.select-button:disabled {
    background-color: #d1d5db;
    cursor: not-allowed;
}
.sector {
    transition: opacity 0.2s;
}
.sector.active:hover {
    opacity: 0.8;
    cursor: pointer;
}
.sector.inactive {
    pointer-events: none;
}
.info-section {
    margin: 20px 0;
}
.info-section .info-wrapper {
    background-color: #E6F5F1;
    padding: 40px;
    border-radius: 18px;
    border: 1px solid #D1E8E2;
    max-width: 1400px;
    margin: 0 auto;
}
.info-section .info-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    gap: 20px;
}
.info-section .info-block {
    background-color: white;
    border-radius: 8px;
    padding: 20px;
    width: 100%;
    max-width: 380px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}
.info-section .info-block h3 {
    font-size: 18px;
    font-weight: bold;
    color: #1F2A44;
    margin-bottom: 10px;
}
.match-info .header-info .price-section {
    display: flex;
    align-items: center;
    margin-right: 100px; /* Сдвигаем левее на 20px, настройте значение по необходимости */
}
.info-section .info-block h3 .number {
    display: inline-block;
    width: 24px;
    height: 24px;
    background-color: #34C759;
    color: white;
    border-radius: 4px;
    text-align: center;
    line-height: 24px;
    margin-right: 8px;
}
.info-section .info-block p {
    font-size: 14px;
    color: #6B7280;
    line-height: 1.5;
}
.contact-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 1400px;
    margin: 20px auto;
}
.contact-section .contact-text {
    font-size: 14px;
    color: #6B7280;
}
.contact-section .contact-text a {
    color: #34C759;
    text-decoration: underline;
}
.contact-section .toggle-tickets {
    background-color: #34C759;
    color: white;
    padding: 8px 16px;
    border-radius: 4px;
    font-weight: bold;
    transition: background-color 0.2s;
    cursor: pointer;
}
.contact-section .toggle-tickets:hover {
    background-color: #2EB648;
}
.tickets-section {
    display: none;
    max-width: 1400px;
    margin: 0 auto;
}
.mb-4.mx-auto {
    max-width: 1400px; /* Ограничиваем ширину как у .stadium-map */
    margin-left: auto;
    margin-right: auto;
}
.tickets-section.active {
    display: block;
}
.tooltip {
    position: absolute;
    background-color: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 10px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    z-index: 10;
    pointer-events: none; /* Чтобы tooltip не мешал взаимодействию с элементами под ним */
    display: none; /* По умолчанию скрыт */
    font-size: 14px;
    color: #1F2A44;
    text-align: center;
}

.tooltip p {
    margin: 2px 0;
}

.tooltip .sector-name {
    font-weight: bold;
    font-size: 16px;
}

.tooltip .price {
    font-weight: bold;
    font-size: 16px;
    color: #1F2A44;
}
</style>
<script src="/static/js/utils.js"></script>
<script>
function selectSector(sectorName) {
    const matchId = "{{ match.id }}";
    window.location.href = `/sector_view/${matchId}/${sectorName}`;
}

function scrollToStadiumMap() {
    document.querySelector('.stadium-map').scrollIntoView({ behavior: 'smooth' });
}

function formatDate(dateString) {
    const months = [
        'Января', 'Февраля', 'Марта', 'Апреля', 'Мая', 'Июня',
        'Июля', 'Августа', 'Сентября', 'Октября', 'Ноября', 'Декабря'
    ];
    const date = new Date(dateString);
    const day = date.getDate();
    const month = months[date.getMonth()];
    const year = date.getFullYear();
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    return `${day} ${month} ${year}, ${hours}:${minutes}`;
}

function toggleTickets() {
    const ticketsSection = document.querySelector('.tickets-section');
    ticketsSection.classList.toggle('active');
}

window.onload = function() {
    updateCartCount();
    const dateElement = document.querySelector('.match-info .date');
    const rawDate = dateElement.getAttribute('data-date');
    dateElement.textContent = formatDate(rawDate);
};


document.addEventListener('DOMContentLoaded', function () {
    const tooltip = document.getElementById('sector-tooltip');
    const sectors = document.querySelectorAll('.sector.active');

    sectors.forEach(sector => {
        sector.addEventListener('mouseover', function (e) {
            const sectorName = sector.getAttribute('data-id');
            const availableSeats = getAvailableSeats(sectorName);
            const price = getSectorPrice(sectorName);

            tooltip.querySelector('.sector-name').textContent = `Сектор ${sectorName}`;
            tooltip.querySelector('#available-seats').textContent = availableSeats;
            tooltip.querySelector('#sector-price').textContent = price;

            tooltip.style.display = 'block';
            tooltip.style.left = e.pageX + 10 + 'px';
            tooltip.style.top = e.pageY + 10 + 'px';
        });

        sector.addEventListener('mousemove', function (e) {
            const tooltipWidth = tooltip.offsetWidth;
            const tooltipHeight = tooltip.offsetHeight;
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;

            let left = e.pageX + 10;
            let top = e.pageY + 10;

            // Предотвращаем выход за правую границу
            if (left + tooltipWidth > windowWidth) {
                left = e.pageX - tooltipWidth - 10;
            }

            // Предотвращаем выход за нижнюю границу
            if (top + tooltipHeight > windowHeight) {
                top = e.pageY - tooltipHeight - 10;
            }

            // Предотвращаем выход за левую границу
            if (left < 0) {
                left = 10;
            }

            // Предотвращаем выход за верхнюю границу
            if (top < 0) {
                top = 10;
            }

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        });

        sector.addEventListener('mouseout', function () {
            tooltip.style.display = 'none';
        });
    });

    function getAvailableSeats(sectorName) {
        const sector = {{ match.sectors | tojson | safe }}.find(s => s.name === sectorName);
        if (sector && sector.seats) {
            return sector.seats.filter(seat => seat.available).length;
        }
        return 0;
    }

    function getSectorPrice(sectorName) {
        const sector = {{ match.sectors | tojson | safe }}.find(s => s.name === sectorName);
        return sector ? sector.price : 0;
    }
});
</script>
</head>
<body class="light-gray">
<header class="dark-green text-white p-4">
<div class="max-w-7xl mx-auto flex justify-between items-center">
    <div class="flex items-center">
        <img src="/static/image/favicon.ico" alt="Логотип ФК Краснодар" class="h-10 mr-4">
        <nav class="flex space-x-8">
            <a href="/" class="hover:underline">Главная</a>
            <a href="/matches" class="hover:underline">Матчи</a>
            <a href="/stadium" class="hover:underline">Стадион</a>
        </nav>
    </div>
    <div>
        <a href="/cart" class="hover:underline">Корзина (<span id="cart-count">0</span>)</a>
    </div>
</div>
</header>
<main>
<div class="match-banner" style="background-image: url('/static/backgrounds/{{ match.image }}')"></div>

<div class="match-info">
    <div style="position: relative; width: 100%;">
        <div class="header-info">
            <div class="match-type">⚽ Футбольный матч</div>
            <div class="location">📍 г. Краснодар, площадка: Краснодар Арена</div>
            <div class="price-section">
                <div class="price">Стоимость: <span>От {{ match.sectors | map(attribute='price') | min }} ₽</span></div>
            </div>
        </div>
        <h2>Билеты на <span>{{ match.teams }}</span></h2>
        <p class="date" data-date="{{ match.date }}"></p>
        <div class="buy-section">
            <a class="buy-button" onclick="scrollToStadiumMap()">Перейти к покупке</a>
        </div>
    </div>
</div>

<div class="info-section">
    <div class="info-wrapper">
        <div class="info-container">
            <div class="info-block">
                <h3><span class="number">1</span> Как выбрать места?</h3>
                <p>Свободные места подсвечивы цветом. Выберите сектор, интересующие вас места и нажмите иконку оформления заказа для ввода контактных данных.</p>
            </div>
            <div class="info-block">
                <h3><span class="number">2</span> Как оплатить билеты?</h3>
                <p>На странице оформления заказа выберите удобный для вас способ оплаты: банковской картой или наличными курьеру при получении билетов.</p>
            </div>
            <div class="info-block">
                <h3><span class="number">3</span> Как получить билеты?</h3>
                <p>С помощью бесплатной доставки или самовывоза. Для удобства воспользуйтесь электронными билетами, которые придут вам на почту.</p>
            </div>
        </div>
    </div>
</div>

{% include 'stadium_map.html' %} <!--  подгрузка svg стадиона   -->

<div id="sector-tooltip" class="tooltip">
    <p class="sector-name">Сектор</p>
    <p>Свободных мест: <span id="available-seats">0</span></p>
    <p class="price">Цена: <span id="sector-price">0</span> ₽</p>
</div>

    <div class="contact-section">
        <div class="contact-text">
            Если у вас возникли вопросы, звоните по номеру <a href="tel:8(861)203-64-04">8 (861) 203-64-04</a>
        </div>
        <div class="toggle-tickets" onclick="toggleTickets()">Список всех билетов</div>
    </div>
    <div class="tickets-section">
        <h4 class="text-md font-semibold mb-2">Доступные секторы: </h4>
        {% for sector in match.sectors %}
            <div class="ticket-section">
                <div>
                    <p>Сектор {{ sector.name }}</p>
                    <p class="text-sm text-gray-500">
                        {% set ns = namespace(available_seats=0) %}
                        {% for seat in sector.seats %}
                            {% if seat.available %}
                                {% set ns.available_seats = ns.available_seats + 1 %}
                            {% endif %}
                        {% endfor %}
                        Доступно билетов: {{ ns.available_seats }}
                    </p>
                </div>
                <div class="flex items-center gap-4">
                    <p>от {{ sector.price }} ₽</p>
                    <a href="/sector_view/{{ match.id }}/{{ sector.name }}" class="select-button" {% if ns.available_seats == 0 %}disabled{% endif %}>Выбрать билет</a>
                </div>
            </div>
        {% endfor %}
    </div>
</div>
</main>
<footer class="bg-gray-800 text-white p-4 text-center">
<p>© 2025 ФК Краснодар. Все права защищены.</p>
</footer>
</body>
</html>